<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Stylish Manage</title>
<style>
body{
	font-size:16px;
	font-family:"Noto Sans TC", "微軟正黑體", "新細明體", arial, sans-serif;
	color:#3f3a3a;
}
textarea{
	width:400px;height:100px;
}
input{
	width:300px;
}
</style>
<script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-storage.js"></script>
<script>
firebase.initializeApp({
	apiKey: "AIzaSyAFEjHsXykE6xo9rya-XFDQatNWHrv1w3Q",
	authDomain: "stylish-appworks.firebaseapp.com",
	databaseURL: "https://stylish-appworks.firebaseio.com",
	projectId: "stylish-appworks",
	storageBucket: "stylish-appworks.appspot.com"
});
let db=firebase.database();
let storage=firebase.storage();
function createProduct(f){
	let id=f.id.value;
	let name=f.name.value;
	let category=f.category.options[f.category.selectedIndex].value;
	let price=f.price.value;
	let colors=f.colors.value.split(",");
	let sizes=f.sizes.value.split(",");
	let summary=f.summary.value.replace(/\r\n/g,"<br/>").replace(/\n/g,"<br/>");
	let story=f.story.value.replace(/\r\n/g,"<br/>").replace(/\n/g,"<br/>");
	let now=(new Date()).getTime();
	let data={
		id:id, name:name, category:category,
		price:price, summary:summary, story:story,
		colors:f.colors.value, sizes:f.sizes.value,
		update_time:now,
		variants:{}
	};
	for(let i=0;i<sizes.length;i++){
		for(let j=0;j<colors.length;j++){
			data.variants[sizes[i]+"-"+colors[j]]={
				size:sizes[i],
				color:colors[j],
				stock:Math.floor(Math.random()*10)
			}
		}
	}
	db.ref("/products/"+id).set(data, function(error){
		if(error){
			console.log("Error", error);
		}else{
			console.log("OK");
			uploadImageFiles(id, f.mainImage.files[0], f.images.files);
		}
	});
}
function uploadImageFiles(id, mainImageFile, imageFiles){
	productRef=storage.ref(id+"/");
	mainRef=productRef.child("main.jpg");
	mainRef.put(mainImageFile).then((snapshot)=>{
		console.log("Main Image Uploaded");
	}).catch((error)=>{
		console.log("Main Image Error");
	});
	for(let i=0;i<imageFiles.length;i++){
		productRef.child("image"+i+".jpg").put(imageFiles[i]).then((snapshot)=>{
			console.log("Image "+i+" Uploaded");
		}).catch((error)=>{
			console.log("Image "+i+" Error");
		});
	}
}
</script>
</head>
<body>
	<h3>Create a New Product</h3>
	<form onsubmit="createProduct(this);return false;">
		ID <input type="text" name="id" /><br/>
		Category <select name="category">
			<option value="women">Women</option>
			<option value="men">Men</option>
			<option value="accessories">Accessories</option>
		</select><br/>
		Name <input type="text" name="name" /><br/>
		Price <input type="text" name="price" /><br/>
		Colors <input type="text" name="colors" value="FFFFFF,DDFFBB,DDF0FF,AAAAAA,995522,334422,334455" /><br/>
		Sizes <input type="text" name="sizes" value="S,M,L,XL,F" /><br/>
		Summary<br/><textarea name="summary"></textarea><br/>
		Story<br/><textarea name="story"></textarea><br/>
		Main Image <input type="file" name="mainImage" /><br/>
		Images <input type="file" name="images" multiple /><br/>
		<br/>
		<input type="submit" value="Create" />
	</form>
</body>
</html>
